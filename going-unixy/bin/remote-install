#!/usr/bin/env sh
# shellcheck disable=SC2029

echo

HOST="$1"
SCRIPTS_PATH="/opt/puter-server"
USAGE="USAGE:
  $0 user@the-host.to-run-on.net
"

if [ -z "$HOST" ]; then
  echo "$USAGE"
  exit 1
fi

set -eu

echo "Removing any existing puter scripts on remote"
ssh "$HOST" rm -rf "$SCRIPTS_PATH"

echo "Copying puter scripts to host"
scp -r "$PWD" "$HOST:$SCRIPTS_PATH"

echo "Ensuring Ruby is installed on the host"
ssh "$HOST" "apt-get update -qq && apt-get install -qq ruby --yes"

echo "Running scripts on host"
ssh "$HOST" "ruby $SCRIPTS_PATH/lib/main.rb"

echo "Done! :)"
